# 試髮前後比較功能說明

## 功能概述

在換髮型完成後，使用者可以通過三個按鈕切換不同的視圖：

1. **試髮前**：顯示原始的個人照片
2. **試髮後**：顯示換髮型後的結果（預設顯示）
3. **前後比較**：顯示並排對比圖，左側為試髮前，右側為試髮後

## 功能實現

### 1. 後端改動

#### `services/photo_service.py`
- 新增 `create_comparison_image()` 方法
- 使用 PIL/Pillow 將試髮前後的圖片水平拼接
- 自動調整圖片大小，統一高度為 800px
- 在圖片頂部添加「試髮前」和「試髮後」文字標籤
- 生成的對比圖保存在 `static/outputs/` 目錄

#### `routes/api.py`
- 修改 `poll_try_on()` 函數
- 在換髮型成功後自動生成前後對比圖
- 在 API 響應中添加三個 URL：
  - `before_url`: 試髮前的照片
  - `result_url`: 試髮後的照片
  - `comparison_url`: 前後對比圖

### 2. 前端改動

#### `templates/user/index.html`
- 在結果顯示區域添加了按鈕組 `view-switcher`
- 包含三個按鈕：「試髮前」、「試髮後」、「前後比較」
- 初始狀態下按鈕組是隱藏的，只在換髮型成功後才顯示

#### `static/js/user.js`
- 新增 `imageUrls` 對象保存三個圖片的 URL
- 新增 `switchView()` 函數處理按鈕切換邏輯
- 修改 `pollTryOnResult()` 函數：
  - 保存三個圖片 URL
  - 顯示按鈕組
  - 默認選中「試髮後」按鈕
- 修改 `resetSession()` 函數：
  - 隱藏按鈕組
  - 清空圖片 URL
- 添加按鈕點擊事件監聽器

#### `static/css/theme.css`
- 添加 `.view-switcher` 樣式
- 按鈕組採用淺紫色背景
- 添加按鈕 hover 效果和 active 狀態樣式
- 按鈕寬度統一為 120px，提升視覺一致性

## 使用流程

1. 使用者上傳個人照片
2. 選擇想要試換的髮型
3. 點擊「立即換髮型」
4. 等待系統處理（生成試髮後照片和對比圖）
5. 換髮型完成後：
   - 預設顯示「試髮後」的照片
   - 按鈕組自動顯示
   - 點擊「試髮前」查看原始照片
   - 點擊「前後比較」查看並排對比
   - 點擊「試髮後」返回結果照片

## 技術細節

### 對比圖生成
- 使用 PIL (Pillow) 圖像處理庫
- 統一高度為 800px，寬度根據原圖比例自動調整
- 兩張圖片之間留 20px 間隔
- 使用系統字體（PingFang）添加標籤，失敗則跳過文字

### 錯誤處理
- 如果對比圖生成失敗，不會影響主流程
- 錯誤信息會在控制台輸出
- 使用者仍可查看試髮前和試髮後的照片

### 性能優化
- 對比圖在換髮型成功後立即生成
- 前端只需加載三個圖片 URL，無需額外請求
- 使用 CSS 過渡效果提升用戶體驗

## 相關文件

- `services/photo_service.py` - 圖片處理服務
- `routes/api.py` - API 路由處理
- `templates/user/index.html` - 前端頁面模板
- `static/js/user.js` - 前端交互邏輯
- `static/css/theme.css` - 樣式表

