# 換髮型系統說明文件

## 系統概述

本系統原為試衣系統，已改造為**試換髮型系統**。使用者可以上傳自己的照片，選擇喜歡的髮型，系統會使用 AI 生成換髮型後的效果圖。

## 主要變更

### 1. 照片驗證機制（新增）

在試換髮型前，系統會使用 LLM（Large Language Model）驗證上傳的照片是否符合要求：

#### 驗證條件
- ✅ 照片中有人物
- ✅ 為正面照或接近正面
- ✅ 包含上半身（至少到肩膀）
- ✅ 頭髮清晰可見
- ✅ 照片品質良好

#### 實作位置
- **服務**: `services/photo_validator.py`
- **API**: `routes/api.py` 中的 `/api/try-on` 端點
- **配置**: `data/settings.json` 中的 `GEMINI_LLM` 設定

#### 驗證流程

```python
# 1. 使用者上傳照片
POST /api/upload-user-photo

# 2. 使用者選擇髮型並開始試換
POST /api/try-on
  ↓
# 3. 系統驗證照片（新增步驟）
photo_validator.validate_photo(user_data_url)
  ↓
# 4a. 驗證通過 → 繼續換髮型流程
provider.start_session_with_analysis(...)
  ↓
# 4b. 驗證失敗 → 返回錯誤訊息
return {"error": "照片不符合要求：..."}
```

### 2. 界面文字更新

所有使用者可見的文字都已從「服飾」改為「髮型」：

#### 前端模板
- `templates/user/index.html`
  - 標題：「觸控換髮型體驗」
  - 步驟提示：「選擇想試換的髮型」
  - 按鈕：「立即換髮型」
  - 結果：「換髮型結果」

- `templates/admin/dashboard.html`
  - 標題：「新增髮型」、「現有髮型」
  - 表單：「髮型名稱」、「髮型圖片」
  - 分類範例：「長髮、短髮、捲髮」

#### JavaScript 檔案
- `static/js/user.js`
  - 所有提示訊息：「照片已更新，可選擇髮型換髮型」
  - 錯誤訊息：「請先選擇想試換的髮型」
  - 狀態顯示：「生成換髮型結果中」
  - 完成訊息：「換髮型完成！」

- `static/js/admin.js`
  - Toast 訊息：「新增髮型完成」、「髮型名稱已更新」
  - 確認對話框：「確定要刪除此髮型嗎？」

#### 後端 API
- `routes/api.py`
  - 錯誤訊息：「找不到選擇的髮型」
  - 成功訊息：「換髮型服務」
  - 記錄註釋：「記錄失敗的換髮型」

### 3. 後端注釋更新

所有程式碼註釋都已更新：

```python
# 修改前
"""Live demo Raspberry Pi 觸控試衣系統 Flask 應用。"""
"""管理觸控試衣系統服飾資料的儲存模組。"""

# 修改後
"""Live demo Raspberry Pi 觸控換髮型系統 Flask 應用。"""
"""管理觸控換髮型系統髮型資料的儲存模組。"""
```

## 技術實作細節

### 照片驗證服務 (`services/photo_validator.py`)

```python
class PhotoValidator:
    """驗證照片是否適合進行試換髮型的服務。"""
    
    def __init__(self, settings_path: Path) -> None:
        """初始化照片驗證器，載入 Gemini LLM 設定。"""
        
    def validate_photo(self, image_data_url: str) -> Dict[str, any]:
        """
        驗證照片是否為半身正面照。
        
        Returns:
            {
                "is_valid": bool,
                "message": str,
                "details": dict  # 可選
            }
        """
```

### 提示詞設計

系統使用精心設計的提示詞來引導 LLM 分析照片：

```
請分析這張照片，判斷是否符合以下條件：
1. 是否為人物照片
2. 是否為正面照或接近正面（臉部清晰可見）
3. 是否包含上半身（至少到肩膀以上）
4. 頭髮是否清晰可見
5. 照片品質是否足夠清晰

請以 JSON 格式回答...
```

### 錯誤處理

如果驗證服務發生錯誤（如 API 連線失敗），系統會自動跳過驗證，避免阻擋使用者：

```python
try:
    validation_result = photo_validator.validate_photo(user_data_url)
except Exception:
    # 發生錯誤時允許通過，避免阻擋用戶
    return {"is_valid": True, "message": "..."}
```

## 使用者體驗流程

### 正常流程

1. 使用者開啟系統 → 看到「觸控換髮型體驗」標題
2. 點擊「📸 拍攝 / 選擇照片」
3. 上傳正面半身照
4. 系統提示：「照片已更新，可選擇髮型換髮型」
5. 瀏覽髮型，點選喜歡的髮型卡片
6. 系統提示：「已選擇髮型，可按『立即換髮型』」
7. 點擊「立即換髮型」按鈕
8. **系統自動驗證照片** ✨
9. 驗證通過，顯示：「生成換髮型結果中，請稍候...」
10. 完成後顯示：「換髮型完成！可繼續挑選其他髮型」

### 驗證失敗流程

1. 使用者上傳側面照或照片品質不佳
2. 點擊「立即換髮型」
3. **系統驗證失敗** ❌
4. 顯示錯誤訊息：「照片不符合要求：請使用正面照或接近正面的角度」
5. 使用者重新拍攝照片
6. 重複流程

## 配置要求

### 必需配置

```json
{
  "GEMINI_API_KEY": "必需 - 用於換髮型和照片驗證",
  "GEMINI_MODEL": "gemini-2.5-flash-image - 用於換髮型",
  "GEMINI_LLM": "gemini-2.0-flash-exp - 用於照片驗證"
}
```

### 可選配置

```json
{
  "KLINGAI_VIDEO_ACCESS_KEY": "可選 - 用於生成動態影片",
  "KLINGAI_VIDEO_SECRET_KEY": "可選 - 用於生成動態影片"
}
```

## 測試建議

### 照片驗證測試

建議使用以下類型的照片測試系統：

✅ **應該通過的照片**
- 正面半身照，臉部和頭髮清晰
- 稍微側面但臉部清晰可見
- 高品質自拍照

❌ **應該失敗的照片**
- 側面照或背面照
- 全身照但臉部太小
- 只有臉部特寫（沒有肩膀）
- 模糊或過暗的照片
- 戴帽子遮住頭髮
- 非人物照片

### 功能測試清單

- [ ] 照片上傳功能正常
- [ ] 照片驗證正確判斷正面照
- [ ] 照片驗證正確拒絕不合格照片
- [ ] 驗證失敗時顯示具體錯誤訊息
- [ ] 驗證通過後可以正常換髮型
- [ ] 所有界面文字都已更新為「髮型」
- [ ] 管理後台可以新增/編輯/刪除髮型
- [ ] 歷史記錄正確保存
- [ ] 影片生成功能正常（如已配置）

## 維護建議

### 調整驗證嚴格度

如果驗證太嚴格或太寬鬆，可以修改 `services/photo_validator.py` 中的提示詞：

```python
prompt = """請分析這張照片，判斷是否符合以下條件：
1. 是否為人物照片
2. 是否為正面照或接近正面（臉部清晰可見）
3. 是否包含上半身（至少到肩膀以上）
4. 頭髮是否清晰可見
5. 照片品質是否足夠清晰

# 可以調整這裡的條件來改變嚴格度
```

### 監控驗證失敗率

建議定期檢查 `data/tryon_history.json` 中狀態為 `failed` 且錯誤訊息包含「照片驗證失敗」的記錄，了解驗證失敗的原因，以優化驗證邏輯。

## 常見問題

### Q: 為什麼有時候驗證會自動跳過？

A: 當驗證服務發生錯誤（如 API 連線失敗）時，系統會自動跳過驗證並顯示提示訊息，這是為了避免技術問題阻擋使用者使用系統。

### Q: 可以關閉照片驗證功能嗎？

A: 可以。在 `routes/api.py` 中註釋掉照片驗證的程式碼即可：

```python
# 驗證照片是否為半身正面照
# validation_result = photo_validator.validate_photo(user_data_url)
# if not validation_result.get("is_valid", False):
#     ...
```

### Q: 驗證使用的是哪個 AI 模型？

A: 使用 `data/settings.json` 中配置的 `GEMINI_LLM` 模型，預設為 `gemini-2.0-flash-exp`。這是一個快速且經濟的模型，適合做照片分析。

## 總結

本次改造主要完成：

1. ✅ 新增照片驗證功能，使用 LLM 判斷照片是否為正面半身照
2. ✅ 所有界面文字從「服飾」改為「髮型」
3. ✅ 所有提示訊息和錯誤訊息已更新
4. ✅ 後端程式碼註釋已更新
5. ✅ README 文檔已更新

系統現在可以正常用於換髮型展示，並且能自動驗證使用者上傳的照片是否符合要求！

---

**文件版本**: 1.0  
**建立日期**: 2025-11-08  
**作者**: AI Assistant

