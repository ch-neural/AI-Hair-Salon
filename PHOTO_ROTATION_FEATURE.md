# 照片旋轉功能說明

## 更新日期
2025-11-09

## 功能概述

在步驟一上傳個人照片後，使用者可以點擊「🔄 旋轉照片」按鈕，將照片依次旋轉 90°、180°、270°，然後回到 0°。旋轉後的照片會重新上傳到服務器，後續所有處理（換髮型、生成影片等）都使用旋轉後的照片。

## 功能特點

### 1. 自動旋轉循環
- 第 1 次點擊：旋轉 90°（順時針）
- 第 2 次點擊：旋轉 180°
- 第 3 次點擊：旋轉 270°
- 第 4 次點擊：旋轉回 0°（原始方向）
- 循環重複...

### 2. 實時預覽
- 每次旋轉後立即更新預覽圖片
- 顯示當前旋轉角度的提示訊息

### 3. 服務器同步
- 旋轉後的照片自動上傳到服務器
- 確保後續所有處理使用旋轉後的版本

## 使用流程

### 正常使用流程：
1. 點擊「📸 拍攝 / 選擇照片」
2. 選擇或拍攝一張照片
3. ✅ 照片上傳成功
4. 🎯 **「🔄 旋轉照片」按鈕自動顯示**
5. 如果照片方向不對，點擊旋轉按鈕
6. 照片旋轉並重新上傳
7. 預覽更新為旋轉後的照片
8. 繼續選擇髮型進行換髮型

### 重新開始流程：
1. 點擊「重新開始」
2. 旋轉按鈕隱藏
3. 旋轉角度重置為 0°
4. 重新上傳照片後，可再次使用旋轉功能

## 技術實現

### 前端實現

#### HTML 結構
```html
<button id="rotate-photo" class="btn btn--secondary btn--large hidden">
  🔄 旋轉照片
</button>
```

#### 狀態管理
```javascript
let currentRotation = 0;        // 當前旋轉角度 (0, 90, 180, 270)
let currentPhotoBlob = null;    // 當前照片的 Blob
```

#### 旋轉邏輯
1. **使用 Canvas API**：
   - 創建 Canvas 元素
   - 根據旋轉角度調整 Canvas 尺寸
   - 使用 `ctx.rotate()` 旋轉圖片
   - 繪製旋轉後的圖片

2. **尺寸處理**：
   - 90° 和 270°：寬高互換
   - 180° 和 0°：保持原尺寸

3. **轉換流程**：
   ```
   原始圖片 → FileReader → Image 對象 → Canvas 旋轉 → Blob → 上傳
   ```

#### Canvas 旋轉代碼
```javascript
// 設置 canvas 尺寸
if (currentRotation === 90 || currentRotation === 270) {
  canvas.width = img.height;
  canvas.height = img.width;
} else {
  canvas.width = img.width;
  canvas.height = img.height;
}

// 旋轉變換
ctx.save();
if (currentRotation === 90) {
  ctx.translate(canvas.width, 0);
  ctx.rotate(Math.PI / 2);
} else if (currentRotation === 180) {
  ctx.translate(canvas.width, canvas.height);
  ctx.rotate(Math.PI);
} else if (currentRotation === 270) {
  ctx.translate(0, canvas.height);
  ctx.rotate(-Math.PI / 2);
}
ctx.drawImage(img, 0, 0);
ctx.restore();
```

### 按鈕顯示控制

#### 顯示時機
- ✅ 上傳照片成功後
- ❌ 初始狀態（未上傳照片時）
- ❌ 點擊「重新開始」後

#### 相關代碼位置
- `static/js/user.js` 第 34 行：狀態變數定義
- `static/js/user.js` 第 259 行：上傳成功後顯示按鈕
- `static/js/user.js` 第 478-563 行：旋轉功能實現
- `static/js/user.js` 第 578 行：重置時隱藏按鈕

### 圖片質量控制
- 使用 JPEG 格式
- 質量設置為 92%（`0.92`）
- 保持良好的圖片品質

## 用戶體驗設計

### 視覺反饋
1. **按鈕狀態**：
   - 初始：隱藏
   - 上傳後：顯示為次要按鈕（btn--secondary）
   - 旋轉中：按鈕禁用

2. **提示訊息**：
   - 旋轉中：「旋轉照片中，請稍候...」
   - 完成：「照片已旋轉 90°」（顯示實際角度）
   - 錯誤：「旋轉失敗，請重試」

3. **即時更新**：
   - 旋轉完成後立即更新預覽
   - 無需重新選擇照片

### 錯誤處理
- 未上傳照片時點擊：「請先上傳照片」
- Canvas 轉換失敗：「旋轉失敗，請重試」
- 上傳失敗：顯示錯誤訊息

## 與其他功能的集成

### 1. 與換髮型功能的集成
- 旋轉後的照片自動保存到服務器
- 換髮型使用最新旋轉後的照片
- 無需額外處理

### 2. 與前後比較功能的集成
- 「試髮前」顯示旋轉後的原始照片
- 確保前後對比使用相同方向

### 3. 與影片生成功能的集成
- 影片使用旋轉後的照片
- 確保影片中人物方向正確

## 測試建議

### 功能測試
1. **基本旋轉**：
   - 上傳照片後點擊旋轉按鈕
   - 確認每次旋轉 90°
   - 確認第 4 次點擊回到原始方向

2. **預覽更新**：
   - 確認旋轉後預覽立即更新
   - 確認照片方向正確

3. **後續處理**：
   - 旋轉後進行換髮型
   - 確認換髮型使用旋轉後的照片
   - 確認前後比較功能正常

4. **狀態重置**：
   - 點擊「重新開始」
   - 確認按鈕隱藏
   - 重新上傳照片
   - 確認旋轉功能可再次使用

### 相容性測試
- 測試不同瀏覽器（Chrome, Safari, Firefox）
- 測試不同設備（桌面、平板、手機）
- 測試不同圖片格式（JPG, PNG, HEIC）

### 性能測試
- 測試大尺寸照片（4000x3000）
- 確認旋轉速度在可接受範圍
- 確認記憶體使用正常

## 已知限制

1. **圖片格式**：
   - 輸出格式固定為 JPEG
   - PNG 透明背景會變為白色

2. **圖片質量**：
   - 每次旋轉會有輕微的質量損失（JPEG 壓縮）
   - 多次旋轉可能累積損失

3. **瀏覽器支援**：
   - 需要支援 Canvas API
   - 需要支援 FileReader API
   - 需要支援 Blob 和 FormData

## 未來改進建議

1. **旋轉角度選擇**：
   - 提供下拉選單直接選擇角度
   - 支援自定義角度（如 45°）

2. **撤銷功能**：
   - 保存旋轉歷史
   - 支援撤銷到上一個狀態

3. **批次處理**：
   - 支援同時上傳多張照片
   - 支援批次旋轉

4. **高級編輯**：
   - 添加裁切功能
   - 添加濾鏡功能
   - 添加亮度/對比度調整

## 相關文件
- `templates/user/index.html` - 旋轉按鈕 UI
- `static/js/user.js` - 旋轉功能實現
- `static/css/theme.css` - 按鈕樣式
- `routes/api.py` - 照片上傳 API

