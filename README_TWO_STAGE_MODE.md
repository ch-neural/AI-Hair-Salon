# TWO-STAGE vs SIMPLE æ¨¡å¼è¯´æ˜

## ğŸ“Š æ¨¡å¼å¯¹æ¯”

### **TWO-STAGE æ¨¡å¼ï¼ˆä¸¤é˜¶æ®µï¼‰** âœ… **å½“å‰ä½¿ç”¨**

```
                    ç”¨æˆ·ç…§ç‰‡ + é«®å‹ç…§
                           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Stage 1: LLM åˆ†æ (gemini-2.5-flash)       â”‚
    â”‚  â€¢ ç†è§£ã€Œåªæ”¹é«®å‹ï¼Œä¸æ”¹å…¶ä»–ã€æŒ‡ä»¤            â”‚
    â”‚  â€¢ ç”Ÿæˆè¯¦ç»†æ–‡å­—æè¿°                         â”‚
    â”‚  â€¢ æ˜ç¡®åŒºåˆ†é«®å‹ç‰¹å¾ vs è¡£ç‰©ç‰¹å¾             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
              ç”Ÿæˆçš„æè¿° + ç”¨æˆ·ç…§ç‰‡ + é«®å‹ç…§
                           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Stage 2: Image Model ç”Ÿæˆ                  â”‚
    â”‚  (gemini-2.5-flash-image)                   â”‚
    â”‚  â€¢ æ ¹æ®æè¿°ç²¾ç¡®ç”Ÿæˆå›¾ç‰‡                     â”‚
    â”‚  â€¢ ä¿æŠ¤è¡£ç‰©ã€èƒŒæ™¯ã€å§¿åŠ¿ç­‰å…ƒç´                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                      æœ€ç»ˆç»“æœ
```

**ä¼˜ç‚¹**ï¼š
- âœ… **ç²¾ç¡®æ§åˆ¶**ï¼šLLM å…ˆç†è§£æŒ‡ä»¤ï¼Œèƒ½å‡†ç¡®åŒºåˆ†ã€Œæ”¹é«®å‹ã€vsã€Œæ”¹è¡£æœã€
- âœ… **æ›´å¥½çš„è¡£ç‰©ä¿æŠ¤**ï¼šä¸¤é˜¶æ®µå¤„ç†ç¡®ä¿è¡£ç‰©ä¸è¢«æ”¹å˜
- âœ… **é€‚åˆå¤æ‚ä»»åŠ¡**ï¼šæ¢é«®å‹ç­‰éœ€è¦ç²¾ç¡®çº¦æŸçš„åœºæ™¯
- âœ… **æ›´æ¸…æ™°çš„æ—¥å¿—**ï¼šå¯ä»¥çœ‹åˆ° LLM ç”Ÿæˆçš„æè¿°

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦ä¸¤æ¬¡ API è°ƒç”¨ï¼ˆé€Ÿåº¦è¾ƒæ…¢ï¼Œçº¦ 10-15 ç§’ï¼‰
- âŒ æˆæœ¬è¾ƒé«˜ï¼ˆä¸¤æ¬¡ Gemini API è°ƒç”¨ï¼‰

---

### **SIMPLE æ¨¡å¼ï¼ˆå•é˜¶æ®µï¼‰** âŒ **å·²åœç”¨**

```
    Prompt + ç”¨æˆ·ç…§ç‰‡ + é«®å‹ç…§
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Image Model ç›´æ¥ç”Ÿæˆ                       â”‚
    â”‚  (gemini-2.5-flash-image)                   â”‚
    â”‚  â€¢ ç›´æ¥æ ¹æ® prompt å’Œå›¾ç‰‡ç”Ÿæˆç»“æœ           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
           æœ€ç»ˆç»“æœ
```

**ä¼˜ç‚¹**ï¼š
- âœ… åªéœ€ä¸€æ¬¡ API è°ƒç”¨ï¼ˆé€Ÿåº¦å¿«ï¼Œçº¦ 5-8 ç§’ï¼‰
- âœ… æˆæœ¬è¾ƒä½

**ç¼ºç‚¹**ï¼š
- âŒ **ç²¾ç¡®åº¦ä¸è¶³**ï¼šImage Model å¯èƒ½ä¸ç†è§£å¤æ‚çš„ã€Œåªæ”¹é«®å‹ã€æŒ‡ä»¤
- âŒ **å®¹æ˜“æ”¹å˜è¡£ç‰©**ï¼šå…¨èº«ç…§æ—¶ç»å¸¸ä¼šæŠŠè¡£æœä¹Ÿæ¢æ‰ï¼ˆæ‚¨é‡åˆ°çš„é—®é¢˜ï¼‰
- âŒ ä¸é€‚åˆéœ€è¦ç²¾ç¡®æ§åˆ¶çš„ä»»åŠ¡

---

## ğŸ”§ å½“å‰é…ç½®

### ä¿®æ”¹ä½ç½®
**æ–‡ä»¶**: `/storeTryon/common/services/tryon_service.py`

**ç¬¬ 682 è¡Œ** (é sensitive æƒ…å†µ):
```python
res = self.gemini.generate_virtual_tryon_two_stage(  # â† TWO-STAGE
    user_image_path=str(user_path),
    garment=garment_for_gemini,
    session_id=session_id,
    user_note=user_note,
)
```

**ç¬¬ 673 è¡Œ** (sensitive æƒ…å†µ):
```python
res = self.gemini.generate_virtual_tryon_two_stage(  # â† TWO-STAGE
    user_image_path=str(user_path),
    garment=garment_for_gemini,
    session_id=session_id,
    user_note=final_note,
)
```

---

## ğŸ“‹ æ—¥å¿—è¾“å‡º

### TWO-STAGE æ¨¡å¼æ—¥å¿—

å¯åŠ¨æ—¶ä¼šçœ‹åˆ°ï¼š
```
========================================
Live Demo è§¸æ§è©¦é«®ç³»çµ±å•Ÿå‹•
ä½¿ç”¨æ¨¡å¼: TWO-STAGE (ç²¾ç¢ºé«®å‹æ§åˆ¶)
========================================
```

æ¢é«®å‹æ—¶ä¼šçœ‹åˆ°ï¼š
```
================================================================================
[GeminiService] TWO-STAGE: Stage 1 Complete Prompt (Text Only):
--------------------------------------------------------------------------------
You are creating a description for a HAIR-ONLY replacement operation...
(å®Œæ•´çš„ Stage 1 prompt)
================================================================================
[GeminiService] TWO-STAGE: Stage 1 - Added user photo (Image 1)
[GeminiService] TWO-STAGE: Stage 1 - Added hairstyle photo (Image 2)
[GeminiService] TWO-STAGE: Calling Gemini LLM for text description with 3 parts
[GeminiService] TWO-STAGE: Stage 1 description generated
[GeminiService] TWO-STAGE: Description: (LLM ç”Ÿæˆçš„æè¿°)

================================================================================
[GeminiService] TWO-STAGE: Stage 2 Complete Prompt (Text Only):
--------------------------------------------------------------------------------
CONTEXT: This is a professional virtual hairstyle try-on service...
(å®Œæ•´çš„ Stage 2 promptï¼ŒåŒ…å«æ‰€æœ‰ç¦æ­¢æ€§æŒ‡ä»¤)
================================================================================
[GeminiService] TWO-STAGE: Added user photo (Image 1)
[GeminiService] TWO-STAGE: Added hairstyle photo (Image 2)
[GeminiService] TWO-STAGE: Calling Gemini for image generation with 3 parts
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹© TWO-STAGE æ¨¡å¼ï¼Ÿ

å¯¹äº**æ¢é«®å‹ç³»ç»Ÿ**ï¼ŒTWO-STAGE æ¨¡å¼æ˜¯æœ€ä½³é€‰æ‹©ï¼ŒåŸå› ï¼š

1. **ç²¾ç¡®æ€§éœ€æ±‚**ï¼šæ¢é«®å‹è¦æ±‚ã€Œåªæ”¹é«®å‹ï¼Œä¸æ”¹è¡£æœã€èƒŒæ™¯ã€å§¿åŠ¿ã€ï¼Œè¿™æ˜¯éå¸¸ç²¾ç¡®çš„çº¦æŸ
2. **LLM ç†è§£åŠ›**ï¼šStage 1 çš„ LLM èƒ½æ›´å¥½åœ°ç†è§£å’Œæ‰§è¡Œã€Œç¦æ­¢æ”¹å˜è¡£ç‰©ã€çš„æŒ‡ä»¤
3. **ä¸¤é˜¶æ®µéªŒè¯**ï¼šç¬¬ä¸€é˜¶æ®µç”Ÿæˆæè¿°æ—¶å°±å·²ç»æ’é™¤äº†è¡£ç‰©ä¿¡æ¯ï¼Œç¬¬äºŒé˜¶æ®µåªéœ€æŒ‰æè¿°ç”Ÿæˆ
4. **å¯è°ƒè¯•æ€§**ï¼šå¯ä»¥çœ‹åˆ° Stage 1 ç”Ÿæˆçš„æè¿°ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œä¼˜åŒ–

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

æ‰§è¡Œï¼š
```bash
./start.sh
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ TWO-STAGE æ¨¡å¼ã€‚

---

## ğŸ“ æ›´æ–°å†å²

- **2025-11-09**: ä» SIMPLE æ¨¡å¼åˆ‡æ¢åˆ° TWO-STAGE æ¨¡å¼
- **åŸå› **: è§£å†³å…¨èº«ç…§æ—¶è¡£ç‰©è¢«æ”¹å˜çš„é—®é¢˜
- **æ•ˆæœ**: æ›´ç²¾ç¡®çš„é«®å‹æ§åˆ¶ï¼Œæ›´å¥½çš„è¡£ç‰©ä¿æŠ¤

